<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Wo ist Markt in Karlsruhe?</title>
        <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css"/>
        <link rel="stylesheet" href="Leaflet.awesome-markers-2.0.2/leaflet.awesome-markers.css"/>
        <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css"/>
        <style>
            html, body, #map {
                height: 100%;
                width: 100%;
                padding: 0;
                margin: 0;
            }

            .leaflet-label {
                font-weight: normal;
            }

            div.info {
                width: 40em;
                white-space: normal;
            }

            .legend {
                margin: 3em;
                border: 1px solid #555;
                background-color: #eee;
                padding: 1em;
                border-radius: 6px;
                -o-border-radius: 6px;
                -moz-border-radius: 6px;
                -webkit-border-radius: 6px;
                color: #555;
                width: 22em;
            }

            .legend p {
                margin: 0;
            }

            .legend h1 {
                margin-top: 0;
                font-size: 120%;
            }
        </style>

        <script src="jquery-1.11.2.min.js"></script>
        <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
        <script src="Leaflet.awesome-markers-2.0.2/leaflet.awesome-markers.min.js"></script>
        <script>
            var TILES_URL = 'http://a.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png';
            var INITIAL_LOCATION = [49.0140679, 8.4044366];
            var INITIAL_ZOOM = 13;
            var ATTRIBUTION = 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> ' +
                              'contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">' +
                              'CC-BY-SA</a>. Tiles &copy; <a href="http://cartodb.com/attributions">' +
                              'CartoDB</a>';

            var map;

            var now = new Date();
            var time = [now.getHours(), now.getMinutes()];
            var dayIndex = (now.getDay() + 6) % 7;  // In our data, first day is Monday
            var dayNames = ['Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag', 'Sonntag'];

            L.AwesomeMarkers.Icon.prototype.options.prefix = 'fa';
            var nowIcon = L.AwesomeMarkers.icon({markerColor: 'green', icon: 'shopping-cart'});
            var todayIcon = L.AwesomeMarkers.icon({markerColor: 'darkgreen', icon: 'shopping-cart'});
            var otherIcon = L.AwesomeMarkers.icon({markerColor: 'cadetblue', icon: 'shopping-cart'});

            /*
             * Return 0-padded string of a number.
             */
            function pad(num, totalDigits) {
                var s = num.toString();
                while (s.length < totalDigits) {
                    s = '0' + s;
                }
                return s;
            }

            /*
             * Create time-table HTML code.
             *
             * `times` is a list of 7 items. Each item is either `null`
             * (market is not open on that day) or a 2-tuple consisting
             * of the opening and closing times (each of which is given
             * as a 2-tuple consisting of the hour and the minutes).
             */
            function timeTable(times) {
                s = '<table class="times">';
                for (var i = 0; i < 7; i++) {
                    var t = times[i];
                    if (t !== null) {
                        s += '<tr><th>' + dayNames[i] + '</th><td>' +
                             t[0][0] + ':' + pad(t[0][1], 2) + ' - ' + t[1][0] + ':' + pad(t[1][1], 2) +
                             '</td></tr>';
                    }
                }
                s += '</table>';
                return s;
            }

            $(document).ready(function() {
                var tiles = new L.TileLayer(TILES_URL, {attribution: ATTRIBUTION});
                map = new L.Map('map').addLayer(tiles).setView(INITIAL_LOCATION, INITIAL_ZOOM);
                $.getJSON("markt.json", function(json) {
                    var nowGroup = L.layerGroup();
                    var todayGroup = L.layerGroup();
                    var otherGroup = L.layerGroup();
                    for (var market in json) {
                        var data = json[market];
                        var times = data['days'];
                        var todayTimes = times[dayIndex];
                        var marker = L.marker(data['location']);
                        marker.bindPopup('<h1>' + market + '</h1>' + timeTable(times));
                        if (todayTimes !== null) {
                            if (todayTimes[0] <= time && time <= todayTimes[1]) {
                                marker.setIcon(nowIcon);
                                nowGroup.addLayer(marker);
                            } else {
                                marker.setIcon(todayIcon);
                                todayGroup.addLayer(marker);
                            }
                        } else {
                            marker.setIcon(otherIcon);
                            otherGroup.addLayer(marker);
                        }
                    }
                    nowGroup.addTo(map);
                    todayGroup.addTo(map);
                    otherGroup.addTo(map);
                });

                var legend = L.control({position: 'bottomright'});
                legend.onAdd = function (m) {
                    var div = L.DomUtil.create('div', 'legend');
                    div.innerHTML = '<h1>Wo ist Markt in Karlsruhe?</h1>' +
                                     '<p>Ein Projekt des <a href="http://codefor.de/karlsruhe">' +
                                     'Open Knowledge Lab Karlsruhe</a>. ' +
                                     '<a href="http://www.karlsruhe.de/b3/maerkte/wochenmarkte.de">' +
                                     'Daten</a> von der Stadt Karlsruhe. ' +
                                     '<a href="https://github.com/CodeforKarlsruhe/wo-ist-markt">Code</a> ' +
                                     'auf GiHub.</p>';
                    return div;
                };
                legend.addTo(map);
            });
        </script>
    </head>
    <body>
        <div id="map"></div>
    </body>
</html>
